# 🚨 Claude AI 개발 규칙 - 절대 준수사항

> **이 파일은 AI 개발 시 반드시 준수해야 할 규칙입니다.**
> **작업 시작 전 반드시 이 파일을 먼저 읽고 확인하세요.**

---

## 🔴 Flyway Migration 규칙 (최우선 중요!)

### ❌ 절대 금지 사항
1. **한번 커밋된 migration 파일 삭제 금지**
   - 이유: 운영 서버의 flyway_schema_history 테이블에 기록이 남아있어 validation 실패
   - 예: V2__xxx.sql 파일을 삭제하면 운영 서버 장애 발생

2. **한번 커밋된 migration 파일 내용 수정 금지**
   - 이유: Flyway가 checksum을 검증하여 변경 감지 시 실패

3. **로컬 개발 중 `docker compose down -v` 사용 금지**
   - 이유: 볼륨 삭제로 DB가 초기화되어 운영과 상태가 달라짐
   - 로컬에서 문제없어도 운영 서버에서 실패할 수 있음

### ✅ 올바른 방법
1. **잘못된 migration은 새로운 migration으로 수정**
   ```
   V2에 문제 있음 → V7__fix_v2_issue.sql 생성 (롤백 또는 수정)
   ```

2. **로컬 테스트도 운영처럼**
   - 볼륨 유지: `docker compose restart` 또는 `docker compose up -d --build`
   - 볼륨 삭제 절대 금지

3. **Migration 파일 작성 전 기존 파일 확인**
   - 중복되는 작업이 없는지 확인
   - V1에 이미 있는 내용을 V2로 만들지 않기

---

## 🔴 Database 관리 규칙

### ❌ 절대 금지
- `docker compose down -v` (볼륨 삭제)
- 운영 서버에서 데이터 삭제 제안
- 테이블 DROP 제안 (마이그레이션 외)

### ✅ 올바른 방법
- `docker compose restart` (서비스만 재시작)
- `docker compose up -d --build` (이미지 재빌드, 데이터 유지)
- 데이터 백업 먼저 확인 후 작업

---

## 🔴 Git 관리 규칙

### ❌ 절대 금지
- 운영에 영향을 주는 파일 삭제 (migration, 설정 파일 등)
- 강제 푸시 (`git push -f`)

### ✅ 올바른 방법
- 변경사항은 항상 새 브랜치에서 작업
- PR 생성하여 검토 후 merge
- 실수 시 revert commit으로 복구

---

## 🔴 배포 및 운영 규칙

### ❌ 절대 금지
- 운영 서버에 직접 실험적인 명령어 실행
- 데이터 손실 가능성이 있는 작업을 사용자 확인 없이 진행
- "로컬에서는 되는데요?" 식의 접근

### ✅ 올바른 방법
- 운영 서버 작업 전 항상 사용자에게 확인
- 로컬과 운영 환경의 차이 항상 고려
- 롤백 계획 먼저 수립

---

## 📋 작업 시작 전 체크리스트

작업을 시작하기 전에 다음을 확인하세요:

- [ ] 이 CLAUDE_RULES.md 파일을 읽었는가?
- [ ] Migration 파일을 건드릴 계획인가? → 절대 삭제/수정 금지 확인
- [ ] DB 볼륨을 건드릴 계획인가? → `-v` 옵션 사용 금지 확인
- [ ] 운영 서버에 영향을 주는 작업인가? → 사용자에게 먼저 확인
- [ ] 롤백 방법을 알고 있는가?

---

## 🔄 실수 발생 시 대응

### 실수한 경우
1. 즉시 사용자에게 알리기
2. 롤백 방법 제시
3. 재발 방지를 위해 이 문서에 규칙 추가

### Migration 파일 실수 복구
1. 삭제한 파일 즉시 복원
2. 커밋 및 푸시
3. 운영 서버에서 pull 및 재배포

---

**⚠️ 이 규칙들을 무시하면 운영 서버 장애가 발생할 수 있습니다!**
**⚠️ 확신이 없으면 사용자에게 먼저 물어보세요!**
